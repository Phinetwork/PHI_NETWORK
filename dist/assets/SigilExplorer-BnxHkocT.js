import{On as e,Sn as t,tn as n}from"./index-DahscM1f.js";var r=e(t(),1);const i=typeof window<`u`;function a(e){let t=Math.max(1,Math.floor(e?.breathMs??5236)),n=Math.max(0,Math.floor(e?.minDelayMs??10)),r=Math.max(0,Math.floor(e?.padMs??6)),i=t-((Date.now()-(typeof e?.phaseOriginEpochMs==`number`&&Number.isFinite(e.phaseOriginEpochMs)?Math.floor(e.phaseOriginEpochMs):0))%t+t)%t;return i===0&&(i=t),i+=r,i<n&&(i=n),i}function o(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function s(e,t){if(!o(e))return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function c(e,t){if(!o(e))return;let n=e[t];return typeof n==`number`&&Number.isFinite(n)?n:void 0}function l(){return i&&typeof window.location?.origin==`string`?window.location.origin:`https://phi.network`}function u(e){return e.replace(/\/{2,}/g,`/`)}function d(e){let t=String(e??``).trim();if(!t)return``;try{let e=new URL(t,l());return e.protocol=e.protocol.toLowerCase(),e.hostname=e.hostname.toLowerCase(),(e.protocol===`https:`&&e.port===`443`||e.protocol===`http:`&&e.port===`80`)&&(e.port=``),e.pathname=u(e.pathname),e.pathname.length>1&&e.pathname.endsWith(`/`)&&(e.pathname=e.pathname.slice(0,-1)),e.hash===`#`&&(e.hash=``),e.toString()}catch{return t}}var f=24e3;function p(e){let t=String(e??``).trim();if(!t)return;let n=t.match(/\/p~([A-Za-z0-9\-_]+)/);if(n?.[1])return n[1].slice(0,f);try{let e=new URL(t,l());if(e.hash){let t=e.hash.startsWith(`#`)?e.hash.slice(1):e.hash,n=new URLSearchParams(t.startsWith(`?`)?t.slice(1):t).get(`p`);if(n&&n.length<=f)return n}let n=e.searchParams.get(`p`);if(n&&n.length<=f)return n;let r=e.pathname.match(/\/p\/([A-Za-z0-9\-_]+)/);if(r?.[1])return r[1].slice(0,f);let i=e.pathname.match(/\/stream\/p\/([A-Za-z0-9\-_]+)/);if(i?.[1])return i[1].slice(0,f)}catch{let e=t.match(/[#?&]p=([A-Za-z0-9\-_]+)/);if(e?.[1])return e[1].slice(0,f);let n=t.match(/\/p\/([A-Za-z0-9\-_]+)/);if(n?.[1])return n[1].slice(0,f)}}function m(e){let t=e.trim();if(!t)return;let n=t.replace(/-/g,`+`).replace(/_/g,`/`),r=n.length%4;if(r===2)n+=`==`;else if(r===3)n+=`=`;else if(r!==0)return;if(i&&typeof window.atob==`function`)try{let e=window.atob(n),t=new Uint8Array(e.length);for(let n=0;n<e.length;n+=1)t[n]=e.charCodeAt(n)&255;if(typeof TextDecoder<`u`)return new TextDecoder(`utf-8`,{fatal:!1}).decode(t);let r=``;for(let e=0;e<t.length;e+=1)r+=String.fromCharCode(t[e]);try{return decodeURIComponent(escape(r))}catch{return r}}catch{return}try{let e=Buffer.from(n,`base64`);if(e&&typeof e.toString==`function`)return e.toString(`utf8`)}catch{}}function h(e){let t=p(e);if(!t)return;let n=m(t);if(n)try{let e=JSON.parse(n);return o(e)?e:void 0}catch{return}}function g(e,t){let n=c(t,`pulse`),r=c(t,`beat`),i=c(t,`stepIndex`);if(n!==void 0&&r!==void 0&&i!==void 0)return`k:${n}:${r}:${i}`;let a=s(t,`kaiSignature`);if(a)return`sig:${a}`;let o=p(e);if(o)return`tok:${o}`;let l=T(e);return l?`h:${l}`:`u:${d(e)}`}function _(e,t){let n=s(t,`canonicalHash`);if(n)return`h:${n}`;let r=T(e);if(r)return`h:${r}`;let i=p(e);if(i)return`tok:${i}`;let a=s(t,`kaiSignature`);return a?`sig:${a}`:`u:${d(e)}`}function v(e){let t=d(e);try{return new URL(t,l()).pathname.startsWith(`/p~`)}catch{return t.includes(`/p~`)}}function y(e){let t=d(e);if(!t)return t;let n=p(t);try{let e=new URL(t,l());return e.hash&&/(^#|[?&])p=/.test(e.hash)?e.toString():n?(e.pathname=`/stream`,e.search=``,e.hash=`#p=${n}`,e.toString()):e.toString()}catch{return n?`/stream#p=${n}`:t}}function b(e){return y(e)}function x(e){let t=d(e);return t.includes(`/p~`)||t.includes(`#p=`)||t.includes(`?p=`)||t.includes(`/stream/p/`)||t.includes(`/p/`)?`post`:t.includes(`/stream`)||t.includes(`/memory`)||t.includes(`stream`)||t.includes(`memory`)?`stream`:t.includes(`/sigil`)||t.includes(`sigil`)?`sigil`:T(t)?`stream`:`unknown`}function S(e,t){let n=d(e),r=0;n.startsWith(`https://`)?r+=30:n.startsWith(`http://`)&&(r+=10);try{let e=new URL(n,l()),t=e.hostname.toLowerCase();(t===`phi.network`||t.endsWith(`.phi.network`))&&(r+=35),e.pathname.startsWith(`/stream`)&&(r+=20),e.pathname.startsWith(`/p~`)&&(r-=25),e.hash.startsWith(`#p=`)&&(r+=18),e.pathname.includes(`/stream/p/`)&&(r+=6),e.searchParams.has(`p`)&&(r+=4)}catch{}let i=x(n);return i===t&&(r+=20),t===`post`&&i===`stream`&&(r-=5),r+=Math.max(-10,10-Math.min(10,Math.floor(n.length/80))),r}function C(e,t){return e.length===0?``:e.slice().map(e=>d(e)).filter(e=>e.length>0).sort((e,n)=>S(n,t)-S(e,t))[0]??d(e[0]??``)}function w(e){let t=e.match(/[0-9a-f]{64}/i);if(t?.[0])return t[0];let n=e.match(/[0-9a-f]{40,128}/i);if(n?.[0])return n[0]}function T(e){let t=String(e??``).trim();if(!t)return;let n=t.match(/\/s\/([0-9a-f]{40,128})/i);if(n?.[1])return n[1];try{let e=new URL(t,l()),n=e.pathname.match(/\/s\/([0-9a-f]{40,128})/i);if(n?.[1])return n[1];let r=e.searchParams,i=r.get(`hash`)||r.get(`h`)||r.get(`s`);if(i){let e=w(i);if(e)return e}if(e.hash){let t=w(e.hash);if(t)return t}let a=w(e.toString());if(a)return a}catch{let e=w(t);if(e)return e}}function ee(e){let t=h(e);if(!t)return;let n=s(t,`originUrl`)||s(t,`origin_url`)||s(t,`origin`)||s(t,`streamUrl`)||s(t,`stream_url`)||s(t,`memoryUrl`)||s(t,`memory_url`)||s(t,`url`);return n?d(n):void 0}const te=`sigil:explorer:registry:v1`,ne=`sigil:modal:registry:v1`;var E=typeof window<`u`;const D=new Map;function O(e){try{return JSON.parse(e)}catch{return null}}function re(){return E?navigator.onLine:!1}function ie(){if(!E)return!1;let e=e=>{try{let t=window.localStorage.getItem(e);if(!t)return[];let n=O(t);return Array.isArray(n)?n.filter(e=>typeof e==`string`&&e.trim().length>0):[]}catch{return[]}},t=[...e(te),...e(ne)];if(t.length===0)return!1;let n=!1;for(let e of t)M(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(n=!0);return n}function ae(){if(E)try{let e=Array.from(D.keys());window.localStorage.setItem(te,JSON.stringify(e))}catch{}}function k(e){let t=e.trim();if(!t)return!1;let n=d(t),r=h(n);if(!r)return!1;let i=D.get(n);if(!i)return D.set(n,r),!0;let a=typeof i.pulse==`number`?i.pulse:-1;return(typeof r.pulse==`number`?r.pulse:-1)>a?(D.set(n,r),!0):!1}function A(e,t){if(!e||typeof e!=`object`)return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function j(e,t){let n=[],r=A(t,`parentUrl`);r&&n.push(r);let i=A(t,`originUrl`);i&&n.push(i);let a=ee(e);return a&&n.push(a),n}function M(e,t){let n=e.trim();if(!n)return!1;let r=new Set,i=[n],a=!1,o=0;for(;i.length>0&&(o+=1,!(o>120));){let e=i.pop();if(!e)continue;let n=d(e);if(r.has(n)||(r.add(n),k(n)&&(a=!0),!t.includeAncestry))continue;let o=D.get(n);if(o)for(let e of j(n,o)){let t=e.trim();if(!t)continue;let n=d(t);r.has(n)||i.push(n)}}return a&&t.persist&&ae(),t.source,t.broadcast,t.enqueueToApi,a}function oe(e){let t=[],n=[],r=e=>{if(typeof e!=`string`)return;let n=e.trim();n&&t.push(n)};if(Array.isArray(e)){for(let t of e)r(t);return{urls:t,rawKrystals:n}}if(!e||typeof e!=`object`)return{urls:t,rawKrystals:n};let i=e,a=[i.urls,i.keys,i.registry,i.sigils];for(let e of a)if(Array.isArray(e))for(let t of e)r(t);let o=i.krystals??i.crystals??i.memoryCrystals;if(Array.isArray(o))for(let e of o)n.push(e);return{urls:t,rawKrystals:n}}var N={Root:[255,72,72],Sacral:[255,160,72],Solar:[255,215,128],Heart:[72,255,170],Throat:[42,197,255],ThirdEye:[90,110,255],Crown:[180,120,255],Ignite:[255,92,72],Integrate:[255,160,72],Harmonize:[255,215,128],Reflekt:[180,120,255],Purify:[42,197,255],Dream:[90,110,255]};function P(e){return!Number.isFinite(e)||e<0?0:e>255?255:Math.round(e)}function se(e){let t=typeof e==`string`?e.trim():``;if(!t)return;let n=Object.keys(N).find(e=>e.toLowerCase()===t.toLowerCase());if(n)return N[n];let r=t.split(/[\s•|,]+/g)[0]??``;if(r){let e=Object.keys(N).find(e=>e.toLowerCase()===r.toLowerCase());if(e)return N[e]}let i=t.toLowerCase(),a=Object.keys(N).find(e=>i.includes(e.toLowerCase()));if(a)return N[a]}function ce(e){let t=se(e);if(!t)return{};let[n,r,i]=t;return{"--fc-arc-r":String(P(n)),"--fc-arc-g":String(P(r)),"--fc-arc-b":String(P(i))}}function F(e,t=10){let n=typeof e==`string`?e:``;if(!n)return``;let r=Math.max(1,Math.floor(t));if(n.length<=r)return n;if(r<=4)return n.slice(0,r);let i=Math.ceil(r/2),a=Math.max(1,Math.floor(r/2)-1);return`${n.slice(0,i)}…${n.slice(n.length-a)}`}function I(e){return typeof e==`number`&&Number.isFinite(e)}function L(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function le(e){if(I(e))return e;if(typeof e==`string`){let t=e.trim();if(!t)return;let n=Number(t);if(Number.isFinite(n))return n}}function R(e,t){return le(e[t])}function z(e,t,n){return e<t?t:e>n?n:e}function B(e,t){let n=z(Math.floor(t?.maxDecimals??6),0,12),r=z(Math.floor(t?.minDecimals??0),0,n);if(!I(e))return`0`;let i=Math.abs(e),a=i>=1?Math.min(4,n):i>=.01?Math.min(6,n):n,o=Math.max(r,a),s=e.toFixed(o);if(o===0)return s;let[c,l=``]=s.split(`.`),u=l;for(;u.length>r&&u.endsWith(`0`);)u=u.slice(0,-1);return u.length>0?`${c}.${u}`:c}function ue(e,t){let n=z(Math.floor(t?.decimals??2),0,8),r=t?.trimZeros??!1;if(!I(e))return`0`;let i=e.toFixed(n);if(!r||n===0)return i;let[a,o=``]=i.split(`.`),s=o;for(;s.length>0&&s.endsWith(`0`);)s=s.slice(0,-1);return s.length?`${a}.${s}`:a}function V(e,t){let n=I(e.pulse)?e.pulse:1/0,r=I(t.pulse)?t.pulse:1/0;if(n!==r)return n-r;let i=I(e.beat)?e.beat:1/0,a=I(t.beat)?t.beat:1/0;return i===a?(I(e.stepIndex)?e.stepIndex:1/0)-(I(t.stepIndex)?t.stepIndex:1/0):i-a}function de(e){let t=le(e);if(t!==void 0)return t;if(!L(e))return;let n=[`phi`,`amountPhi`,`phiAmount`,`amount_phi`,`valuePhi`,`phi_value`,`amount`,`value`];for(let t of n){let n=R(e,t);if(n!==void 0)return n}for(let t of[`transfer`,`tx`,`resonance`,`move`,`payment`,`send`,`receive`,`feed`]){let r=e[t];if(L(r))for(let e of n){let t=R(r,e);if(t!==void 0)return t}}}var H=`sigil:urlHealth:v1`;const U=new Map;var W=typeof window<`u`;function fe(e){return e>0?1:e<0?-1:0}function pe(){if(W)try{let e=window.localStorage.getItem(H);if(!e)return;let t=JSON.parse(e);if(!Array.isArray(t))return;U.clear();for(let e of t){if(!Array.isArray(e)||e.length!==2)continue;let[t,n]=e;if(typeof t!=`string`||typeof n!=`number`)continue;let r=d(t),i=fe(n);i!==0&&U.set(r,i)}}catch{}}function me(){if(W)try{let e=[];for(let[t,n]of U)n!==0&&e.push([t,n]);window.localStorage.setItem(H,JSON.stringify(e))}catch{}}function he(e,t){if(!W){let n=d(e);t===0?U.delete(n):U.set(n,t);return}let n=d(e);t===0?U.delete(n):U.set(n,t),me()}function ge(e){return e>=200&&e<400}async function _e(e,t=5500){if(!W)return`bad`;let n=d(e),r=new AbortController,i=window.setTimeout(()=>r.abort(),Math.max(250,t));try{return ge((await fetch(n,{method:`GET`,cache:`no-store`,mode:`cors`,credentials:`omit`,redirect:`follow`,signal:r.signal})).status)?`ok`:`bad`}catch(e){return e instanceof DOMException&&e.name===`AbortError`?`timeout`:`bad`}finally{window.clearTimeout(i)}}var G=typeof window<`u`,ve=`sigil:apiBaseHint:v1`,ye=`sigil:apiBackupDeadUntilMs:v1`,be=300*1e3;function xe(){return Date.now()}function Se(e){try{let t=import.meta.env?.[e];return typeof t==`string`&&t.trim().length>0?t.trim():null}catch{return null}}function Ce(){if(!G)return`https://phi.network`;try{return new URL(`/`,window.location.href).origin}catch{return`https://phi.network`}}function we(){if(!G)return null;try{let e=window.localStorage.getItem(ve);return typeof e==`string`&&e.trim().length>0?e.trim():null}catch{return null}}function Te(){we()}function Ee(e){if(G)try{window.localStorage.setItem(ve,e)}catch{}}function De(){if(G)try{window.localStorage.getItem(ye)}catch{}}function Oe(){if(!G)return!1;try{let e=window.localStorage.getItem(ye),t=e?Number(e):0;return Number.isFinite(t)&&t>xe()}catch{return!1}}function ke(){if(G)try{window.localStorage.setItem(ye,String(xe()+be))}catch{}}function Ae(){let e=we(),t=Se(`VITE_SIGIL_API_BASE`)??e??Ce(),n=Se(`VITE_SIGIL_API_BACKUP_BASE`),r=n&&n!==t?n:null,i=[];return t&&i.push(t),r&&!Oe()&&i.push(r),i}function je(e){return e>=200&&e<500}async function Me(e,t){let n=Ae();if(n.length===0)return null;let r=null;for(let i=0;i<n.length;i+=1){let a=n[i]??``,o=e(a);try{let e=await fetch(o,t);if(r=e,je(e.status))return Ee(a),e;if(i===0&&n.length>1)continue;return e}catch{if(i===0&&n.length>1)continue;return i===1&&ke(),null}}return r}var Ne=typeof window<`u`;const Pe=`sigil:inhaleQueue:v1`;var K={urls:[],krystals:[]};function Fe(){if(!Ne)return{urls:[],krystals:[]};try{let e=window.localStorage.getItem(Pe);if(!e)return{urls:[],krystals:[]};let t=JSON.parse(e);if(!t||typeof t!=`object`)return{urls:[],krystals:[]};let n=t;return{urls:Array.isArray(n.urls)?n.urls.filter(e=>typeof e==`string`):[],krystals:Array.isArray(n.krystals)?n.krystals.slice():[]}}catch{return{urls:[],krystals:[]}}}function Ie(){if(!Ne)return;let e=Fe();K.urls=e.urls,K.krystals=e.krystals}function Le(){if(Ne)try{window.localStorage.setItem(Pe,JSON.stringify(K))}catch{}}function q(e){let t=d(e);t&&(K.urls.includes(t)||K.urls.push(t),Le())}function Re(e){K.krystals.push(e),Le()}function ze(){for(let e of D.keys())q(e)}function Be(e){for(let t of e)q(t)}function Ve(){let e={};return K.urls.length>0&&(e.urls=K.urls.slice()),K.krystals.length>0&&(e.krystals=K.krystals.slice()),e}async function He(){if(!Ne||K.urls.length===0&&K.krystals.length===0)return;let e=Ve(),t=await Me(e=>new URL(`/sigils/inhale`,e).toString(),{method:`POST`,headers:{"content-type":`application/json`},cache:`no-store`,body:JSON.stringify(e)});t&&t.ok&&(K.urls=[],K.krystals=[],Le())}var Ue=typeof window<`u`;function We(e){if(!e||typeof e!=`object`)return null;let t=e,n=typeof t.seal==`string`?t.seal:void 0,r=t.urls;return{seal:n,urls:Array.isArray(r)?r.filter(e=>typeof e==`string`):[]}}async function Ge(e){if(!Ue)return{imported:0};let t=await Me(e=>new URL(`/sigils/urls`,e).toString(),{method:`GET`,cache:`no-store`,signal:e});if(!t||!t.ok)return{imported:0};let n=null;try{n=await t.json()}catch{return{imported:0}}let r=We(n);if(!r)return{imported:0};let i=0;for(let e of r.urls)M(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`remote`,enqueueToApi:!1})&&(i+=1);return i>0&&ae(),{imported:i,remoteSeal:r.seal??null}}var Ke=`sigil:usernameClaims:v1`,qe=`sigil:username-claim`,Je=typeof window<`u`;function Ye(e){let t=e.trim().replace(/^@+/,``).toLowerCase(),n=``;for(let e=0;e<t.length;e+=1){let r=t[e]??``;(r>=`a`&&r<=`z`||r>=`0`&&r<=`9`||r===`_`||r===`.`||r===`-`)&&(n+=r)}return n}function Xe(){if(!Je)return{};try{let e=window.localStorage.getItem(Ke);if(!e)return{};let t=JSON.parse(e);return!t||typeof t!=`object`?{}:t}catch{return{}}}function Ze(e){if(!Je)return()=>{};let t=t=>{let n=t.detail;!n||typeof n.normalized!=`string`||e(n)},n=t=>{if(t.key===Ke&&t.newValue)try{let n=JSON.parse(t.newValue);if(!n||typeof n!=`object`)return;let r=n;for(let t of Object.keys(r)){let n=r[t];n&&typeof n.normalized==`string`&&e(n)}}catch{}};return window.addEventListener(qe,t),window.addEventListener(`storage`,n),()=>{window.removeEventListener(qe,t),window.removeEventListener(`storage`,n)}}var Qe=typeof window<`u`;const $e=`sigil:transfer:update`;function J(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function Y(e,t){let n=e[t];if(typeof n==`number`&&Number.isFinite(n))return n;if(typeof n==`string`&&n.trim().length>0){let e=Number(n);if(Number.isFinite(e))return e}}function X(e,t){let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function et(){let e=new Map;if(!Qe)return e;try{let t=window.localStorage.getItem(`sigil:transferRegistry:v1`);if(!t)return e;let n=JSON.parse(t);if(!Array.isArray(n))return e;for(let t of n){if(!J(t))continue;let n=X(t,`canonicalHash`),r=X(t,`direction`),i=Y(t,`amount`),a=Y(t,`updatedAtMs`);!n||r!==`send`&&r!==`receive`||i==null||e.set(n,{canonicalHash:n,direction:r,amount:i,amountUsd:Y(t,`amountUsd`),sentPulse:Y(t,`sentPulse`),updatedAtMs:a??0})}}catch{}return e}function tt(e,t){if(!e)return;let n=t.get(e);if(n)return{direction:n.direction,amount:n.amount,amountUsd:n.amountUsd,sentPulse:n.sentPulse}}function nt(e){if(!J(e))return;let t=[];J(e.transfer)&&t.push(e.transfer),J(e.move)&&t.push(e.move),J(e.feed)&&J(e.feed.transfer)&&t.push(e.feed.transfer);for(let e of t){if(!J(e))continue;let t=X(e,`direction`);if(t!==`send`&&t!==`receive`)continue;let n=Y(e,`amount`)??Y(e,`phi`);if(n!=null)return{direction:t,amount:n,amountUsd:Y(e,`amountUsd`)??Y(e,`usd`),sentPulse:Y(e,`sentPulse`)??Y(e,`pulse`)}}}function rt(e){let t=X(e,`transferUrl`)??X(e,`transfer_url`);if(!t)return;let n=nt(h(t));if(n)return n;try{let e=new URL(t,`https://example.invalid`),n=e.searchParams.get(`dir`)??e.searchParams.get(`direction`),r=n===`send`||n===`receive`?n:null,i=e.searchParams.get(`amount`)??e.searchParams.get(`phi`),a=i?Number(i):NaN;if(!r||!Number.isFinite(a))return;let o=e.searchParams.get(`usd`)??e.searchParams.get(`amountUsd`),s=o?Number(o):NaN,c=e.searchParams.get(`sentPulse`)??e.searchParams.get(`pulse`),l=c?Number(c):NaN;return{direction:r,amount:a,amountUsd:Number.isFinite(s)?s:void 0,sentPulse:Number.isFinite(l)?l:void 0}}catch{return}}function it(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function at(e,t){if(!it(e))return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function ot(e){let t=new Map,n=new Map;for(let[r,i]of e){let e=d(r),a=x(e),o=_(e,i),s=g(e,i);t.set(e,o);let c=n.get(o);if(!c){n.set(o,{payload:i,urls:new Set([e]),kind:a,momentKey:s});continue}V(i,c.payload)>0&&(c.payload=i),c.urls.add(e);let l=c.momentKey,u=s;l.startsWith(`u:`)&&!u.startsWith(`u:`)&&(c.momentKey=u),l.startsWith(`h:`)&&(u.startsWith(`k:`)||u.startsWith(`sig:`)||u.startsWith(`tok:`))&&(c.momentKey=u)}let r=new Map;for(let[e,t]of n){let n=C(Array.from(t.urls),t.kind);r.set(e,{id:e,payload:t.payload,urls:t.urls,primaryUrl:n,kind:t.kind,momentKey:t.momentKey})}let i=new Map;for(let e of r.values()){let t=e.momentKey;i.has(t)||i.set(t,[]),i.get(t).push(e.id)}let a=new Map,o=new Map,s=new Map;for(let[e,t]of i){let n=t.map(e=>r.get(e)).filter(Boolean),i=n.filter(e=>e.kind===`post`),c;c=i.length>0?i.slice().sort((e,t)=>S(t.primaryUrl,`post`)-S(e.primaryUrl,`post`))[0]:n.slice().sort((e,t)=>S(t.primaryUrl,t.kind)-S(e.primaryUrl,e.kind))[0];let l=c?.id??t[0];a.set(e,l);for(let e of t)o.set(e,l);for(let e of t){let t=r.get(e);if(t)for(let e of t.urls)s.set(e,l)}}let c=new Map;for(let e of r.values()){let n=o.get(e.id)??e.id;if(e.id!==n)continue;let r=at(e.payload,`originUrl`),i=r?d(r):ee(e.primaryUrl)??e.primaryUrl,a=t.get(i),l=s.get(i)??(a?o.get(a):void 0);c.set(n,l??n)}let l=new Map;for(let e of r.values()){let n=o.get(e.id)??e.id,r=c.get(n)??n,i;if(e.id!==n)i=n;else{let n=at(e.payload,`parentUrl`);if(n){let r=d(n),a=t.get(r),c=s.get(r)??(a?o.get(a):void 0);c&&c!==e.id&&(i=c)}}l.set(e.id,{id:e.id,payload:e.payload,urls:e.urls,primaryUrl:e.primaryUrl,kind:e.kind,momentKey:e.momentKey,parentId:i,originId:r,momentParentId:n})}return l}function st(e,t){let n=[];for(let[r,i]of t)i.parentId===e&&n.push(r);return n.sort((e,n)=>V(t.get(n).payload,t.get(e).payload)),n}function ct(e,t,n=new Set){let r=t.get(e);if(!r)return null;if(n.has(e))return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:[]};n.add(e);let i=st(e,t).map(e=>ct(e,t,n)).filter(Boolean);return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:i}}function lt(e){let t=0,n=e.payload,r=e=>{t+=1,V(e.payload,n)>0&&(n=e.payload),e.children.forEach(r)};return r(e),{nodeCount:t,latest:n}}function ut(e){let t=ot(e),n=new Map;for(let[e,r]of t){let t=r.originId;n.has(t)||n.set(t,[]),n.get(t).push(e)}let r=[];for(let e of n.keys()){let n=ct(e,t);if(!n)continue;let i=lt(n);r.push({root:n,nodeCount:i.nodeCount,latest:i.latest})}return r.sort((e,t)=>{let n=V(t.latest,e.latest);return n===0?t.nodeCount===e.nodeCount?V(t.root.payload,e.root.payload):t.nodeCount-e.nodeCount:n}),r.map(e=>e.root)}function dt(e){let t=e.payload;if(it(t)&&typeof t.canonicalHash==`string`)return t.canonicalHash;let n=T(e.url);if(n)return n;for(let t of e.urls){let e=T(t);if(e)return e;let n=h(t);if(!n)continue;let r=n;if(it(r)&&typeof r.canonicalHash==`string`)return r.canonicalHash}}var Z=e(n(),1),Q=typeof window<`u`,ft=`sigil:explorer:open`,pt=`sigil:explorer:bc:v1`,mt=650,ht=450,gt=60,_t=3,vt=`data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20128%20128%22%3E%0A%20%20%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20x2%3D%221%22%20y1%3D%220%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22white%22%20stop-opacity%3D%220.92%22%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22white%22%20stop-opacity%3D%220.62%22%2F%3E%0A%20%20%20%20%20%20%20%20%3C%2FlinearGradient%3E%0A%20%20%20%20%20%20%3C%2Fdefs%3E%0A%20%20%20%20%20%20%3Ccircle%20cx%3D%2264%22%20cy%3D%2264%22%20r%3D%2258%22%20fill%3D%22none%22%20stroke%3D%22url(%23g)%22%20stroke-width%3D%226%22%2F%3E%0A%20%20%20%20%20%20%3Cpath%20d%3D%22M44%2034h40v12H74c10%200%2018%208%2018%2018s-8%2018-18%2018H56v12h-12V82h-8V70h8V58h-8V46h8V34h12v12h18c4%200%206%204%206%206s-2%206-6%206H56v12h18c10%200%2018-8%2018-18S84%2034%2074%2034H44z%22%20fill%3D%22url(%23g)%22%2F%3E%0A%20%20%20%20%3C%2Fsvg%3E`;function $(){return Date.now()}function yt(e){let t=(Q?window:null)?.CSS?.escape;return typeof t==`function`?t(e):e.replace(/["\\]/g,`\\$&`)}function bt(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function xt(e,t){return bt(e)&&typeof e[t]==`string`}function St(e,t){let n=tt(dt(e),t);if(n)return n;let r=nt(e.payload);if(r)return r;let i=e.payload,a=rt(i);if(a)return a;if(bt(i.feed)){let e=rt(i.feed);if(e)return e}for(let t of e.urls){let e=h(t);if(!e)continue;let n=nt(e);if(n)return n;let r=rt(e);if(r)return r}}function Ct(e,t,n){let r=e.payload,i=[],a=new Set,o=de(e.payload);o!==void 0&&i.push({label:`This glyph Φ`,value:`${B(o)} Φ`});let s=St(e,n);if(s){i.push({label:`Φ ${s.direction===`receive`?`Received`:`Sent`}`,value:`${s.direction===`receive`?`+`:`-`}${B(s.amount)} Φ`}),s.amountUsd!==void 0&&i.push({label:`USD value`,value:`$${ue(s.amountUsd)}`}),s.sentPulse!==void 0&&i.push({label:`Sent pulse`,value:String(s.sentPulse)});let e=s;xt(e,`txHash`)&&i.push({label:`Tx hash`,value:e.txHash})}let c=r.feed,l=typeof c?.author==`string`?c.author:typeof r.author==`string`?r.author:void 0,u=c?c.usernameClaim:void 0,d=u?Ye(u.payload?.normalized||u.payload?.username||``):``,f=Ye(l??``),p=d||f;if(p){let e=t[p],n=typeof l==`string`&&l.trim().length>0?l.trim():`@${p}`;e?(i.push({label:`Username (claimed)`,value:`${n} → glyph ${F(e.claimHash,10)}`}),i.push({label:`Claim glyph`,value:y(e.claimUrl)})):i.push({label:`Username`,value:n})}let m=(e,t)=>{let n=r[e];typeof n==`string`&&n.trim().length>0&&!a.has(e)&&(i.push({label:t,value:n.trim()}),a.add(e))};m(`userPhiKey`,`PhiKey`),m(`phiKey`,`PhiKey`),m(`phikey`,`PhiKey`),m(`kaiSignature`,`Kai Signature`),typeof r.parentUrl==`string`&&r.parentUrl.length>0&&i.push({label:`Parent URL`,value:y(r.parentUrl)}),typeof r.originUrl==`string`&&r.originUrl.length>0&&i.push({label:`Origin URL`,value:y(r.originUrl)});let h=r.label??r.title??r.type??r.note??r.description;typeof h==`string`&&h.trim().length>0&&i.push({label:`Label / Type`,value:h.trim()}),i.push({label:`Primary URL`,value:y(e.url)});let g=e.urls.filter(e=>!v(e)).map(e=>y(e));return e.urls.length>1&&i.push({label:`URL variants`,value:g.length===0?`${e.urls.length} urls (kept in data; hidden from browser view)`:g.length<=3?g.join(` | `):`${e.urls.length} urls (kept in data; rendered once)`}),i.slice(0,12)}async function wt(e){if(Q){try{if(navigator.clipboard&&typeof navigator.clipboard.writeText==`function`){await navigator.clipboard.writeText(e);return}}catch{}try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}catch{}}}async function Tt(e){if(Q)try{await fetch(e,{method:`GET`,cache:`force-cache`,mode:`cors`,credentials:`omit`,redirect:`follow`})}catch{}}function Et({p:e}){let t=typeof e.pulse==`number`?e.pulse:0,n=typeof e.beat==`number`?e.beat:0,r=typeof e.stepIndex==`number`?e.stepIndex:0;return(0,Z.jsxs)(`span`,{className:`k-stamp`,title:`pulse ${t} • beat ${n} • step ${r}`,children:[(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`pulse `,t]}),(0,Z.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`beat `,n]}),(0,Z.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`step `,r]})]})}function Dt({node:e,expanded:t,toggle:n,phiTotalsByPulse:i,usernameClaims:a,transferRegistry:o}){let s=t.has(e.id),c=dt(e),l=e.payload.kaiSignature,u=e.payload.chakraDay,d=typeof e.payload.pulse==`number`?e.payload.pulse:void 0,f=d==null?void 0:i.get(d),p=b(e.url),m=s?Ct(e,a,o):[],h=St(e,o);return(0,Z.jsxs)(`div`,{className:`node`,style:ce(u),"data-chakra":String(u??``),"data-node-id":e.id,children:[(0,Z.jsxs)(`div`,{className:`node-row`,children:[(0,Z.jsxs)(`div`,{className:`node-main`,children:[(0,Z.jsx)(`button`,{className:`twirl`,"aria-label":s?`Collapse memories`:`Expand memories`,"aria-expanded":s,onClick:()=>n(e.id),title:s?`Collapse`:`Expand`,type:`button`,children:(0,Z.jsx)(`span`,{className:`tw ${s?`open`:``}`})}),(0,Z.jsx)(`a`,{className:`node-link`,href:p,target:`_blank`,rel:`noopener noreferrer`,title:p,children:(0,Z.jsx)(`span`,{children:F(l??c??`glyph`,12)})})]}),(0,Z.jsxs)(`div`,{className:`node-meta`,children:[(0,Z.jsx)(Et,{p:e.payload}),u&&(0,Z.jsx)(`span`,{className:`chakra`,title:String(u),children:String(u)}),h&&(0,Z.jsxs)(`span`,{className:`phi-move phi-move--${h.direction}`,title:`Φ ${h.direction===`receive`?`received`:`sent`}: ${B(h.amount)} Φ${h.amountUsd===void 0?``:` • $${ue(h.amountUsd)}`}${h.sentPulse===void 0?``:` • sent pulse ${h.sentPulse}`}`,children:[(0,Z.jsx)(`img`,{className:`phi-move__mark`,src:vt,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`lazy`,draggable:!1}),(0,Z.jsx)(`span`,{className:`phi-move__sign`,"aria-hidden":`true`,children:h.direction===`receive`?`+`:`-`}),(0,Z.jsxs)(`span`,{className:`phi-move__amount`,children:[B(h.amount),` Φ`]}),h.amountUsd!==void 0&&(0,Z.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,ue(h.amountUsd)]})]}),f!==void 0&&(0,Z.jsxs)(`span`,{className:`phi-pill`,title:`Total Φ on pulse ${e.payload.pulse??``}`,children:[`Φ pulse: `,B(f),`Φ`]}),(0,Z.jsx)(`button`,{className:`node-copy`,"aria-label":`Copy URL`,onClick:()=>void wt(p),title:`Copy URL`,type:`button`,children:`⧉`})]})]}),s&&(0,Z.jsxs)(`div`,{className:`node-open`,children:[(0,Z.jsx)(`div`,{className:`node-detail`,children:m.length===0?(0,Z.jsx)(`div`,{className:`node-detail-empty`,children:`No additional memory fields recorded on this glyph.`}):(0,Z.jsx)(`div`,{className:`node-detail-grid`,children:m.map(e=>(0,Z.jsxs)(r.Fragment,{children:[(0,Z.jsx)(`div`,{className:`detail-label`,children:e.label}),(0,Z.jsx)(`div`,{className:`detail-value`,title:e.value,children:e.value})]},e.label))})}),e.children.length>0&&(0,Z.jsx)(`div`,{className:`node-children`,"aria-label":`Memory Imprints`,children:e.children.map(e=>(0,Z.jsx)(Dt,{node:e,expanded:t,toggle:n,phiTotalsByPulse:i,usernameClaims:a,transferRegistry:o},e.id))})]})]})}function Ot({root:e,expanded:t,toggle:n,phiTotalsByPulse:i,usernameClaims:a,transferRegistry:o}){let s=(0,r.useMemo)(()=>{let t=0,n=e=>{t+=1,e.children.forEach(n)};return n(e),t},[e]),c=T(e.url),l=e.payload.kaiSignature,u=b(e.url),d=e.payload.chakraDay;return(0,Z.jsxs)(`section`,{className:`origin`,"aria-label":`Sigil origin stream`,style:ce(d),"data-chakra":String(d??``),"data-node-id":e.id,children:[(0,Z.jsxs)(`header`,{className:`origin-head`,children:[(0,Z.jsxs)(`div`,{className:`o-meta`,children:[(0,Z.jsx)(`span`,{className:`o-title`,children:`Origin`}),(0,Z.jsx)(`a`,{className:`o-link`,href:u,target:`_blank`,rel:`noopener noreferrer`,title:u,children:F(l??c??`origin`,14)}),d&&(0,Z.jsx)(`span`,{className:`o-chakra`,title:String(d),children:String(d)})]}),(0,Z.jsxs)(`div`,{className:`o-right`,children:[(0,Z.jsx)(Et,{p:e.payload}),(0,Z.jsxs)(`span`,{className:`o-count`,title:`Total content keys in this lineage`,children:[s,` keys`]}),(0,Z.jsx)(`button`,{className:`o-copy`,onClick:()=>void wt(u),title:`Copy origin URL`,type:`button`,children:`Remember Origin`})]})]}),(0,Z.jsx)(`div`,{className:`origin-body`,children:e.children.length===0?(0,Z.jsx)(`div`,{className:`kx-empty`,children:`No memories yet. The stream begins here.`}):(0,Z.jsx)(`div`,{className:`tree`,children:e.children.map(e=>(0,Z.jsx)(Dt,{node:e,expanded:t,toggle:n,phiTotalsByPulse:i,usernameClaims:a,transferRegistry:o},e.id))})})]})}function kt({onAdd:e,onImport:t,onExport:n,total:i,lastAdded:a}){let[o,s]=(0,r.useState)(``);return(0,Z.jsx)(`div`,{className:`kx-toolbar`,role:`region`,"aria-label":`Explorer toolbar`,children:(0,Z.jsxs)(`div`,{className:`kx-toolbar-inner`,children:[(0,Z.jsxs)(`div`,{className:`kx-brand`,children:[(0,Z.jsx)(`div`,{className:`kx-glyph`,"aria-hidden":!0,children:(0,Z.jsx)(`img`,{className:`kx-glyph__mark`,src:vt,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`eager`,draggable:!1})}),(0,Z.jsxs)(`div`,{className:`kx-title`,children:[(0,Z.jsxs)(`h1`,{children:[`KAIROS `,(0,Z.jsx)(`span`,{children:`Keystream`})]}),(0,Z.jsx)(`div`,{className:`kx-tagline`,children:`Sovereign Lineage • No DB • Pure Φ`})]})]}),(0,Z.jsxs)(`div`,{className:`kx-controls`,children:[(0,Z.jsxs)(`form`,{className:`kx-add-form`,onSubmit:t=>{t.preventDefault(),o.trim()&&(e(o.trim()),s(``))},children:[(0,Z.jsx)(`input`,{className:`kx-input`,placeholder:`Inhale a sigil (or memory)…`,spellCheck:!1,value:o,onChange:e=>s(e.target.value),"aria-label":`Sigil Key`}),(0,Z.jsx)(`button`,{className:`kx-button`,type:`submit`,children:`Inhale`})]}),(0,Z.jsxs)(`div`,{className:`kx-io`,role:`group`,"aria-label":`Import and export`,children:[(0,Z.jsxs)(`label`,{className:`kx-import`,title:`Import a JSON list of Keys (or krystals)`,children:[(0,Z.jsx)(`input`,{type:`file`,accept:`application/json`,onChange:e=>{let n=e.target.files?.[0];n&&t(n)},"aria-label":`Import JSON`}),`Inhale`]}),(0,Z.jsx)(`button`,{className:`kx-export`,onClick:n,"aria-label":`Export registry to JSON`,type:`button`,children:`Exhale`})]}),(0,Z.jsxs)(`div`,{className:`kx-stats`,"aria-live":`polite`,children:[(0,Z.jsxs)(`span`,{className:`kx-pill`,title:`Total KEYS in registry (includes variants)`,children:[i,` KEYS`]}),a&&(0,Z.jsxs)(`span`,{className:`kx-pill subtle`,title:a,children:[`Last: `,F(a,8)]})]})]})]})})}var At=()=>{let[e,t]=(0,r.useState)(0),[n,i]=(0,r.useState)(0),[o,s]=(0,r.useState)(void 0),[c,l]=(0,r.useState)(()=>Xe()),u=(0,r.useRef)(!1),f=(0,r.useRef)(new Set),p=(0,r.useRef)(null),m=(0,r.useRef)(!1),_=(0,r.useRef)(null),v=(0,r.useRef)(0),C=(0,r.useRef)(null),w=(0,r.useRef)(!1),T=(0,r.useRef)(void 0),ee=(0,r.useRef)([]),E=(0,r.useRef)(null),O=(0,r.useCallback)(e=>{let t=$()+e;t>v.current&&(v.current=t)},[]),k=(0,r.useCallback)(()=>{if(!Q||u.current)return;let e=$(),n=v.current-e;if(n>0){C.current!=null&&window.clearTimeout(C.current),C.current=window.setTimeout(()=>{C.current=null,k()},n+gt);return}let i=ee.current.splice(0);if(i.length>0&&(0,r.startTransition)(()=>{l(e=>{let t=e;for(let e of i){let n=t[e.normalized];n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===(e.originHash??n.originHash)&&n.ownerHint===(e.ownerHint??n.ownerHint)||(t={...t,[e.normalized]:{...n,normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash??n?.originHash,ownerHint:e.ownerHint??n?.ownerHint??null,updatedAtMs:n?.updatedAtMs??0}})}return t})}),T.current!==void 0){let e=T.current;T.current=void 0,(0,r.startTransition)(()=>s(e))}w.current&&(w.current=!1,(0,r.startTransition)(()=>t(e=>e+1)))},[O]),A=(0,r.useCallback)(()=>{if(!Q||C.current!=null)return;let e=$(),t=v.current-e,n=Math.max(0,t)+gt;C.current=window.setTimeout(()=>{C.current=null,k()},n)},[k]),j=(0,r.useCallback)(()=>{if(!u.current){if($()<v.current||m.current){w.current=!0,A();return}(0,r.startTransition)(()=>t(e=>e+1))}},[A]),N=(0,r.useCallback)(e=>{if(!u.current){if($()<v.current||m.current){T.current=e,A();return}(0,r.startTransition)(()=>s(e))}},[A]),P=(0,r.useRef)(null),[se,ce]=(0,r.useState)(()=>new Set),F=(0,r.useCallback)(e=>{O(ht);let t=p.current;if(t){let n=`[data-node-id="${yt(e)}"]`,r=t.querySelector(n);P.current={id:e,scrollTop:t.scrollTop,rectTop:r?r.getBoundingClientRect().top:0}}ce(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}),A()},[O,A]);(0,r.useEffect)(()=>{if(!Q)return;let e=document.documentElement,t=document.body,n=document.scrollingElement||document.documentElement,r={htmlOverscroll:e?.style.overscrollBehavior??``,htmlOverscrollY:e?.style.overscrollBehaviorY??``,bodyOverscroll:t?.style.overscrollBehavior??``,bodyOverscrollY:t?.style.overscrollBehaviorY??``,rootOverscroll:n?.style.overscrollBehavior??``,rootOverscrollY:n?.style.overscrollBehaviorY??``};return e&&(e.style.overscrollBehavior=`none`,e.style.overscrollBehaviorY=`none`),t&&(t.style.overscrollBehavior=`none`,t.style.overscrollBehaviorY=`none`),n&&(n.style.overscrollBehavior=`none`,n.style.overscrollBehaviorY=`none`),()=>{e&&(e.style.overscrollBehavior=r.htmlOverscroll,e.style.overscrollBehaviorY=r.htmlOverscrollY),t&&(t.style.overscrollBehavior=r.bodyOverscroll,t.style.overscrollBehaviorY=r.bodyOverscrollY),n&&(n.style.overscrollBehavior=r.rootOverscroll,n.style.overscrollBehaviorY=r.rootOverscrollY)}},[]),(0,r.useEffect)(()=>{if(!Q)return;let e=p.current;if(!e)return;let t=0,n=0,r=e=>{e.touches.length===1&&(t=e.touches[0]?.clientY??0,n=e.touches[0]?.clientX??0)},i=r=>{if(!r.cancelable||r.touches.length!==1)return;let i=r.touches[0]?.clientY??0,a=r.touches[0]?.clientX??0,o=i-t,s=a-n;if(t=i,n=a,Math.abs(o)<=Math.abs(s))return;let c=e.scrollHeight-e.clientHeight;if(c<=0)return;let l=e.scrollTop<=0,u=e.scrollTop>=c-1,d=o>0,f=o<0;(l&&d&&window.scrollY<=0||u&&f)&&r.preventDefault()};return e.addEventListener(`touchstart`,r,{passive:!0}),e.addEventListener(`touchmove`,i,{passive:!1}),()=>{e.removeEventListener(`touchstart`,r),e.removeEventListener(`touchmove`,i)}},[]),(0,r.useEffect)(()=>{if(!Q)return;let e=p.current;if(!e)return;let t=()=>{m.current=!0,O(mt),_.current!=null&&window.clearTimeout(_.current),_.current=window.setTimeout(()=>{m.current=!1,_.current=null,A()},180)};return e.addEventListener(`scroll`,t,{passive:!0}),()=>{e.removeEventListener(`scroll`,t),_.current!=null&&window.clearTimeout(_.current),_.current=null,m.current=!1}},[O,A]),(0,r.useLayoutEffect)(()=>{let e=P.current;if(!e)return;P.current=null;let t=p.current;if(!t)return;let n=`[data-node-id="${yt(e.id)}"]`,r=t.querySelector(n);if(!r)return;let i=r.getBoundingClientRect().top-e.rectTop;Number.isFinite(i)&&Math.abs(i)>1&&(t.scrollTop=Math.max(0,e.scrollTop+i))},[se]);let I=(0,r.useRef)(null),L=(0,r.useRef)(!1),le=(0,r.useRef)(null);(0,r.useEffect)(()=>{if(u.current=!1,De(),Te(),pe(),Ie(),ie()&&j(),Q){let e=d(window.location.href);if(h(e)){let t=M(e,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});q(e),N(y(e)),t&&j()}}let e=window.__SIGIL__?.registerSigilUrl;window.__SIGIL__||(window.__SIGIL__={}),window.__SIGIL__.registerSigilUrl=e=>{let t=M(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0});q(e),t&&(N(y(e)),j())};let t=e=>{let t=e?.detail?.url;if(typeof t==`string`&&t.length){let e=M(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0});q(t),e&&(N(y(t)),j())}};window.addEventListener(`sigil:url-registered`,t);let n=e=>{let t=e?.detail?.url;if(typeof t==`string`&&t.length){let e=M(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0});q(t),e&&(N(y(t)),j())}};window.addEventListener(`sigil:minted`,n);let o=Q&&`BroadcastChannel`in window?new BroadcastChannel(pt):null,s=e=>{let t=e.data;if(t?.type===`sigil:add`&&typeof t.url==`string`){let e=M(t.url,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});q(t.url),e&&(N(y(t.url)),j())}};o?.addEventListener(`message`,s);let c=e=>{if(!e.key)return;let t=e.key===te,n=e.key===ne;if(e.key===`sigil:transferRegistry:v1`){i(e=>e+1);return}if(!(!t&&!n)&&e.newValue)try{let t=JSON.parse(e.newValue);if(!Array.isArray(t))return;let n=!1;for(let e of t)typeof e==`string`&&(M(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(n=!0),q(e));N(void 0),n&&(ae(),j())}catch{}};window.addEventListener(`storage`,c);let f=()=>i(e=>e+1);window.addEventListener($e,f);let p=Q&&`BroadcastChannel`in window?new BroadcastChannel(`sigil:transfer:bc:v1`):null,g=e=>{e.data?.type===`transfer:update`&&i(e=>e+1)};p?.addEventListener(`message`,g);let _=()=>{Le(),He()};window.addEventListener(`pagehide`,_);let b=Ze(e=>{if($()<v.current||m.current){ee.current.push({normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash,ownerHint:e.ownerHint}),A();return}(0,r.startTransition)(()=>{l(t=>{let n=t[e.normalized];return n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?t:{...t,[e.normalized]:e}})})}),x=new AbortController,S=async e=>{if(!u.current&&re()&&!L.current&&!m.current&&!($()<v.current&&(e===`pulse`||e===`import`))){L.current=!0;try{await He();let t=I.current,n=await Me(e=>new URL(`/sigils/seal`,e).toString(),{method:`GET`,cache:`no-store`,signal:x.signal,headers:void 0});if(!n||n.status===304||!n.ok)return;let r=``;try{let e=await n.json();r=typeof e?.seal==`string`?e.seal:``}catch{return}if(t&&r&&t===r){I.current=r;return}let i=await Ge(x.signal);I.current=i.remoteSeal??r??t??null,i.imported>0&&(N(void 0),j());let a=I.current;(e===`open`||(e===`visible`||e===`focus`||e===`online`||e===`import`)&&a!==le.current)&&(ze(),le.current=a,await He())}finally{L.current=!1}}};E.current=S,ze(),S(`open`);let w=null,T=()=>{if(!Q||u.current)return;w!=null&&window.clearTimeout(w);let e=a();w=window.setTimeout(()=>{if(w=null,document.visibilityState!==`visible`){T();return}if(!re()){T();return}S(`pulse`),T()},e)},D=()=>T();T();let O=()=>{document.visibilityState===`visible`&&(D(),S(`visible`))};document.addEventListener(`visibilitychange`,O);let k=()=>{D(),S(`focus`)},oe=()=>{D(),S(`online`)};return window.addEventListener(`focus`,k),window.addEventListener(`online`,oe),()=>{window.__SIGIL__&&(window.__SIGIL__.registerSigilUrl=e),window.removeEventListener(`sigil:url-registered`,t),window.removeEventListener(`sigil:minted`,n),window.removeEventListener(`storage`,c),window.removeEventListener($e,f),p?.removeEventListener(`message`,g),p?.close(),window.removeEventListener(`pagehide`,_),window.removeEventListener(`focus`,k),window.removeEventListener(`online`,oe),document.removeEventListener(`visibilitychange`,O),o?.removeEventListener(`message`,s),o?.close(),typeof b==`function`&&b(),C.current!=null&&window.clearTimeout(C.current),C.current=null,w!=null&&window.clearTimeout(w),w=null,x.abort(),E.current=null,u.current=!0}},[j,O,A,N]);let R=(0,r.useCallback)(e=>{let t=E.current;t&&t(e)},[]);(0,r.useEffect)(()=>{if(!Q)return;let e=()=>R(`visible`);return window.addEventListener(ft,e),()=>window.removeEventListener(ft,e)},[R]);let z=(0,r.useMemo)(()=>ut(D),[e]),B=(0,r.useMemo)(()=>et(),[n]),ue=(0,r.useMemo)(()=>{let e=0;for(let[,]of D)e+=1;return e},[e]),V=(0,r.useMemo)(()=>{let e=new Map,t=new Map;for(let[n,r]of D){let i=typeof r.pulse==`number`?r.pulse:void 0;if(i==null)continue;let a=g(d(n),r),o=t.get(i);if(o||(o=new Set,t.set(i,o)),o.has(a))continue;o.add(a);let s=de(r);s!==void 0&&e.set(i,(e.get(i)??0)+s)}return e},[e]),H=(0,r.useMemo)(()=>{let e=[];for(let[t]of D){let n=d(b(t));e.includes(n)||e.push(n)}return e},[e]);(0,r.useEffect)(()=>{if(!Q||H.length===0)return;let e=H.filter(e=>!f.current.has(e));if(e.length===0)return;let t=!1,n=async()=>{for(let n of e){if(t)break;f.current.add(n),await Tt(n)}},r=window,i=null;if(typeof r.requestIdleCallback==`function`){let e=r.requestIdleCallback(()=>void n(),{timeout:1e3});i=()=>r.cancelIdleCallback?.(e)}else{let e=window.setTimeout(()=>void n(),120);i=()=>window.clearTimeout(e)}return()=>{t=!0,i?.()}},[H]);let W=(0,r.useCallback)(async()=>{if(!Q||m.current||!re()||$()<v.current)return;let e=[],t=n=>{if(n.urls.length>1){let t=x(n.url),r=[...n.urls].map(e=>d(y(e))).filter((e,t,n)=>n.indexOf(e)===t).sort((e,n)=>S(n,t)-S(e,t));for(let t of r.slice(0,2)){let n=d(t);!U.has(n)&&!e.includes(n)&&e.push(n)}}n.children.forEach(t)};for(let e of z)t(e);if(e.length!==0)for(let t of e.slice(0,_t)){let e=await _e(t);e===`ok`&&he(t,1),e===`bad`&&he(t,-1)}},[z]);(0,r.useEffect)(()=>{if(!Q)return;let e=!1,t=()=>{e||W()},n=window,r=null;if(typeof n.requestIdleCallback==`function`){let e=n.requestIdleCallback(t,{timeout:900});r=()=>n.cancelIdleCallback?.(e)}else{let e=window.setTimeout(t,250);r=()=>window.clearTimeout(e)}return()=>{e=!0,r?.()}},[e,W]);let fe=(0,r.useCallback)(e=>{O(ht);let t=M(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0});q(e),t&&(N(y(e)),j())},[j,O,N]),me=(0,r.useCallback)(async e=>{O(ht);let t=await e.text(),{urls:n,rawKrystals:r}=oe(JSON.parse(t));if(n.length===0&&r.length===0)return;let i=!1;for(let e of r)Re(e);for(let e of n)M(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`import`,enqueueToApi:!0})&&(i=!0),q(e);n.length>0&&Be(n),i&&(N(void 0),j()),R(`import`)},[j,O,R,N]),ge=(0,r.useCallback)(()=>{O(ht);let e=[];for(let[t]of D)e.push(t);let t=new Blob([JSON.stringify({urls:e},null,2)],{type:`application/json`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`sigil-registry-${Date.now()}.json`,n.click(),URL.revokeObjectURL(n.href)},[O]);return(0,Z.jsxs)(`div`,{className:`sigil-explorer`,"aria-label":`Kairos Keystream Explorer`,children:[(0,Z.jsx)(kt,{onAdd:fe,onImport:me,onExport:ge,total:ue,lastAdded:o}),(0,Z.jsx)(`div`,{className:`explorer-scroll`,ref:p,role:`region`,"aria-label":`Explorer scroll viewport`,children:(0,Z.jsxs)(`div`,{className:`explorer-inner`,children:[z.length===0?(0,Z.jsxs)(`div`,{className:`kx-empty`,children:[(0,Z.jsx)(`p`,{children:(0,Z.jsx)(`strong`,{children:`No origins inhaled yet.`})}),(0,Z.jsxs)(`ol`,{children:[(0,Z.jsx)(`li`,{children:`Paste a stream/sigil URL into the input.`}),(0,Z.jsxs)(`li`,{children:[`Press `,(0,Z.jsx)(`strong`,{children:`Inhale`}),`.`]}),(0,Z.jsx)(`li`,{children:`Open nodes to see lineage + Φ evidence.`})]})]}):(0,Z.jsx)(`div`,{className:`forest`,"aria-label":`Sigil forest`,children:z.map(e=>(0,Z.jsx)(Ot,{root:e,expanded:se,toggle:F,phiTotalsByPulse:V,usernameClaims:c,transferRegistry:B},e.id))}),(0,Z.jsx)(`footer`,{className:`kx-footer`,"aria-label":`Explorer footer`,children:(0,Z.jsxs)(`span`,{className:`row`,children:[(0,Z.jsx)(`span`,{children:`φ-breath sync`}),(0,Z.jsx)(`span`,{className:`dot`,children:`•`}),(0,Z.jsx)(`span`,{children:re()?`online`:`offline`}),(0,Z.jsx)(`span`,{className:`dot`,children:`•`}),(0,Z.jsxs)(`span`,{children:[ue,` keys`]})]})})]})})]})};export{At as default};